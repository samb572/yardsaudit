<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear Edge Sports - NFL Receiving Yards Model</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif; background: #111a29; color: white;
            padding: 20px; line-height: 1.6; position: relative; overflow-x: hidden; min-height: 100vh;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #111a29 0%, #1a2332 30%, #0f1419 70%, #111a29 100%);
            z-index: -2;
        }
        body::after {
            content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: 
                conic-gradient(from 0deg at 25% 25%, transparent 0deg, rgba(59, 130, 246, 0.08) 45deg, transparent 90deg),
                conic-gradient(from 180deg at 75% 75%, transparent 0deg, rgba(255, 215, 0, 0.08) 45deg, transparent 90deg);
            animation: rotate 25s linear infinite; z-index: -1;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes shimmer { 0% { opacity: 0.3; } 100% { opacity: 1; } }
        
        .main-content { display: block; position: relative; z-index: 1; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; color: white; margin-bottom: 20px; font-size: 3rem; font-weight: 900; text-transform: uppercase; letter-spacing: 3px; text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5); }
        .model-subtitle { text-align: center; color: #FFD700; font-size: 16px; text-transform: uppercase; letter-spacing: 2px; font-weight: 700; margin-bottom: 40px; }
        
        .input-card, .results {
            background: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 215, 0, 0.15); border-radius: 20px;
            padding: 30px; backdrop-filter: blur(15px); position: relative; overflow: hidden; margin-bottom: 30px;
        }
        .input-card::before, .results::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, transparent, #FFD700, transparent);
            animation: shimmer 3s ease-in-out infinite alternate;
        }
        
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #FFD700; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        input[type="file"], select {
            width: 100%; padding: 12px 15px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px; color: white; font-size: 16px; transition: all 0.3s ease; outline: none;
        }
        input[type="file"] { color: rgba(255, 255, 255, 0.7); padding: 15px; }
        input[type="file"]::-webkit-file-upload-button {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #111a29; border: none; border-radius: 6px;
            padding: 8px 15px; font-weight: 600; cursor: pointer; margin-right: 10px;
        }
        
        .calculate-btn {
            width: 100%; padding: 18px; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #111a29; border: none; border-radius: 12px; font-size: 18px; font-weight: 700;
            cursor: pointer; transition: all 0.3s ease; margin-top: 20px; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        }
        .calculate-btn:hover:not(:disabled) { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5); }
        .calculate-btn:disabled { opacity: 0.6; cursor: not-allowed; background: rgba(255, 255, 255, 0.2); }
        
        .info-text { font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-top: 5px; font-style: italic; }
        .progress-bar { width: 100%; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); width: 0%; transition: width 0.3s ease; }
        .loading, .error, .success { text-align: center; padding: 20px; font-weight: 600; }
        .loading { color: #FFD700; } .error { color: #ef4444; } .success { color: #22c55e; }
        
        .debug { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; margin: 10px 0; font-family: 'Courier New', monospace; font-size: 12px; color: #ccc; max-height: 200px; overflow-y: auto; }
        .csv-upload-info { background: rgba(59,130,246,0.1); border: 2px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px; color: rgba(255,255,255,0.9); font-size: 14px; line-height: 1.6; }
        .csv-upload-info h4 { color: #3b82f6; margin-bottom: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .file-status { text-align: center; padding: 10px; border-radius: 8px; margin-top: 10px; font-weight: 600; }
        .file-status.pending { background: rgba(255, 165, 0, 0.1); color: orange; }
        .file-status.loaded { background: rgba(34, 197, 94, 0.1); color: #22c55e; }

        .download-btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none;
            padding: 15px 30px; border-radius: 12px; font-weight: 700; cursor: pointer; margin: 10px 5px;
            text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease; font-size: 16px;
            box-shadow: 0 5px 20px rgba(34,197,94,0.3);
        }
        .download-btn:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 8px 25px rgba(34,197,94,0.5); }
        
        .week-progress, .week-results-summary { text-align: center; margin: 20px 0; }
        .week-results-summary { background: rgba(34,197,94,0.1); border: 2px solid rgba(34,197,94,0.3); border-radius: 12px; padding: 20px; }
        .week-results-summary h4 { color: #22c55e; }
        .recommendations-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 15px 0; }
        .recommendation-stat { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; text-align: center; border: 1px solid rgba(255,215,0,0.2); }
        .recommendation-stat .count { font-size: 24px; font-weight: 700; color: #FFD700; display: block; }
        .recommendation-stat .label { font-size: 12px; color: rgba(255,255,255,0.7); text-transform: uppercase; margin-top: 5px; }
        
        #detailedResultsContainer { margin-top: 30px; overflow-x: auto; }
        .results-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .results-table th, .results-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .results-table th { background-color: rgba(255,215,0,0.1); color: #FFD700; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; }
        .results-table tr:hover { background-color: rgba(255,255,255,0.05); }
        .results-table td.win { color: #22c55e; font-weight: bold; }
        .results-table td.loss { color: #ef4444; font-weight: bold; }
        .results-table td.push { color: #A0A0A0; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 2.5rem; }
            .input-card, .results { padding: 20px; }
            .recommendations-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="main-content" id="mainContent">
        <div class="container">
            <h1>NFL Receiving Yards Model</h1>
            <p class="model-subtitle">Weekly Audit Tool</p>
            
            <div class="input-card">
                <div class="csv-upload-info">
                    <h4>1. Upload Betting Lines CSV</h4>
                    <p><strong>Required Columns:</strong> week, player_name, home_team, away_team, bet_type, line, odds</p>
                </div>
                <div class="input-group">
                    <label for="csvFile">Select Betting Lines CSV File</label>
                    <input type="file" id="csvFile" accept=".csv">
                    <div id="csvFileStatus" class="file-status pending">Waiting for file...</div>
                </div>

                <div class="csv-upload-info" style="margin-top: 40px;">
                    <h4>2. Upload Gamelog CSV</h4>
                    <p>This should be the detailed player stats export. The tool will find the "Name" and "YDS" columns automatically.</p>
                </div>
                <div class="input-group">
                    <label for="gamelogCsvFile">Select Gamelog CSV File</label>
                    <input type="file" id="gamelogCsvFile" accept=".csv">
                     <div id="gamelogFileStatus" class="file-status pending">Waiting for file...</div>
                </div>

                <div class="input-group" id="weekSelectorContainer" style="display: none;">
                    <label for="weekSelect">3. Select Week to Process</label>
                    <select id="weekSelect"><option value="">Choose a week...</option></select>
                </div>
                <button class="calculate-btn" id="processWeekBtn" disabled>Process Selected Week</button>
                <div id="debugConsole" class="debug" style="display: none;"><strong>Debug Console:</strong><br><div id="debugOutput"></div></div>
            </div>

            <div id="weekProgressContainer" style="display: none;"></div>
            <div id="loadingDiv" class="loading" style="display: none;"></div>
            <div id="errorDiv" class="error" style="display: none;"></div>
            <div id="successDiv" class="success" style="display: none;"></div>

            <div id="resultsContainer" class="results" style="display: none;">
                <div class="week-results-summary">
                    <h4 id="weekResultTitle"></h4>
                    <p id="weekResultSummary"></p>
                    <div class="recommendations-grid" id="recommendationsGrid"></div>
                </div>
                <div id="detailedResultsContainer"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="download-btn" id="downloadBtn">📊 Download Audit Results CSV</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script>
        const DOM = {
            csvFileInput: document.getElementById('csvFile'),
            gamelogFileInput: document.getElementById('gamelogCsvFile'),
            csvFileStatus: document.getElementById('csvFileStatus'),
            gamelogFileStatus: document.getElementById('gamelogFileStatus'),
            weekSelectorContainer: document.getElementById('weekSelectorContainer'),
            weekSelect: document.getElementById('weekSelect'),
            processWeekBtn: document.getElementById('processWeekBtn'),
            debugConsole: document.getElementById('debugConsole'),
            debugOutput: document.getElementById('debugOutput'),
            weekProgressContainer: document.getElementById('weekProgressContainer'),
            loadingDiv: document.getElementById('loadingDiv'),
            errorDiv: document.getElementById('errorDiv'),
            successDiv: document.getElementById('successDiv'),
            resultsContainer: document.getElementById('resultsContainer'),
            weekResultTitle: document.getElementById('weekResultTitle'),
            weekResultSummary: document.getElementById('weekResultSummary'),
            recommendationsGrid: document.getElementById('recommendationsGrid'),
            detailedResultsContainer: document.getElementById('detailedResultsContainer'),
            downloadBtn: document.getElementById('downloadBtn'),
        };

        const SUPABASE_URL = 'https://pyjtwdgapmbdgtpflzan.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5anR3ZGdhcG1iZGd0cGZsemFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExNTEzNTgsImV4cCI6MjA2NjcyNzM1OH0._Bt_XomEPAYRqC6zNgkNDwq66XFlpMoPbNMB6Eb4USo';
        const SEASON = 2024;
        let supabaseClient;
        let csvData = null, weekResults = [], gamelogData = new Map(), currentWeek = null;

        window.addEventListener('load', initialize);

        function initialize() {
            debugLog('Application initializing...');
            try {
                if (!window.supabase) throw new Error('Supabase library not loaded');
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                debugLog('Supabase client initialized.');
                setupEventListeners();
                setupSecurity();
                debugLog('Application ready.');
            } catch (error) {
                handleFatalError('Initialization failed: ' + error.message);
            }
        }

        function setupEventListeners() {
            DOM.csvFileInput.addEventListener('change', handleCSVUpload);
            DOM.gamelogFileInput.addEventListener('change', handleGamelogUpload);
            DOM.weekSelect.addEventListener('change', () => {
                 DOM.processWeekBtn.disabled = !DOM.weekSelect.value;
            });
            DOM.processWeekBtn.addEventListener('click', processSelectedWeek);
            DOM.downloadBtn.addEventListener('click', downloadResults);
        }

        function setupSecurity() {
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('keydown', e => {
                if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || (e.ctrlKey && e.keyCode === 85)) e.preventDefault();
                if (e.ctrlKey && e.shiftKey && e.keyCode === 68) enableDebugMode();
            });
        }
        
        // --- CSV Parsing ---

        function parseGenericCSV(csvText, requiredHeaders) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) throw new Error('CSV file is empty or has no data rows.');
            const headers = lines.shift().trim().split(',').map(h => h.trim().replace(/"/g, ''));
            
            if (!requiredHeaders.every(h => headers.includes(h))) {
                throw new Error(`CSV is missing one or more required headers. Expected: ${requiredHeaders.join(', ')}`);
            }
            
            return lines.map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                headers.forEach((header, index) => { row[header] = values[index]; });
                return row;
            });
        }

        // Specialized parser for the detailed gamelog format
        function parseGamelogCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 3) throw new Error('Gamelog CSV appears to be empty or malformed.');

            // Find the actual header row, which should contain "Rank", "Name", "Team", etc.
            let headerRowIndex = lines.findIndex(line => line.includes('"Rank"') && line.includes('"Name"'));
            if (headerRowIndex === -1) throw new Error('Could not find the header row in the gamelog file. Expected a row with "Rank", "Name", etc.');
            
            const headers = lines[headerRowIndex].trim().split(',').map(h => h.trim().replace(/"/g, ''));
            const nameIndex = headers.indexOf('Name');
            const yardsIndex = headers.indexOf('YDS');

            if (nameIndex === -1 || yardsIndex === -1) {
                throw new Error('Gamelog CSV must have "Name" and "YDS" columns.');
            }

            const dataRows = lines.slice(headerRowIndex + 1);
            const gamelogMap = new Map();
            dataRows.forEach(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                const playerName = values[nameIndex];
                const yards = parseFloat(values[yardsIndex]);
                if (playerName && !isNaN(yards)) {
                    gamelogMap.set(playerName, yards);
                }
            });
            return gamelogMap;
        }


        // --- File Handlers ---
        
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const required = ['week', 'player_name', 'home_team', 'away_team', 'bet_type', 'line', 'odds'];
                    csvData = parseGenericCSV(e.target.result, required);
                    updateFileStatus(DOM.csvFileStatus, `${csvData.length} rows loaded.`);
                    checkPrerequisites();
                } catch (error) {
                    handleFatalError('Error parsing betting lines CSV: ' + error.message);
                    updateFileStatus(DOM.csvFileStatus, 'Error!', false);
                    csvData = null;
                }
            };
            reader.readAsText(file);
        }

        function handleGamelogUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    gamelogData = parseGamelogCSV(e.target.result);
                    updateFileStatus(DOM.gamelogFileStatus, `${gamelogData.size} entries loaded.`);
                    checkPrerequisites();
                } catch (error) {
                    handleFatalError('Error parsing gamelog file: ' + error.message);
                    updateFileStatus(DOM.gamelogFileStatus, 'Error!', false);
                    gamelogData.clear();
                }
            };
            reader.readAsText(file);
        }
        
        function checkPrerequisites() {
            if (csvData && gamelogData.size > 0) {
                debugLog('All prerequisites met. Populating week selector.');
                updateUI_AfterCSVLoad();
            }
        }

        // --- Core Application Logic ---

        async function processSelectedWeek() {
            currentWeek = DOM.weekSelect.value;
            if (!currentWeek) { showError('Please select a week.'); return; }
            
            debugLog(`Starting processing for Week ${currentWeek}`);
            resetUIForNewWeek();
            
            const weekData = csvData.filter(r => r.week == currentWeek && r.bet_type === 'Over');
            if (weekData.length === 0) { showError(`No "Over" betting data found for Week ${currentWeek}.`); return; }

            showLoading(true, `Processing ${weekData.length} players...`);
            updateProgress(0, weekData.length, 'Initializing...');
            
            const allPromises = weekData.map((row, index) => 
                processPlayer(row).finally(() => updateProgress(index + 1, weekData.length, row.player_name))
            );

            const results = await Promise.all(allPromises);
            
            weekResults = results.filter(Boolean);
            const errorCount = weekData.length - weekResults.length;

            showLoading(false);
            DOM.weekProgressContainer.style.display = 'none';

            if (weekResults.length > 0) {
                debugLog(`Processing complete: ${weekResults.length} successful, ${errorCount} errors.`);
                displayWeekResults();
            } else {
                handleFatalError(`No valid projections generated for Week ${currentWeek}. Check debug console.`);
            }
        }
        
        async function processPlayer(row) {
            const { player_name, line, odds, home_team, away_team } = row;
            try {
                const { data: pData, error: pErr } = await supabaseClient.from('player_cover_stats').select('team, tprr_player, routes_run, g, separation_score').eq('player_name', player_name).eq('season', SEASON).eq('coverage_type', 'Overall').single();
                if (pErr) throw new Error(`Player data not found.`);
                
                const { data: yptData, error: yErr } = await supabaseClient.from('nfl_wr_general_stats').select('yards_per_target').eq('player_name', player_name).eq('season', SEASON).single();
                if (yErr) throw new Error(`YPT data not found.`);

                const routesPerGame = pData.routes_run && pData.g ? (pData.routes_run / pData.g) : 35;
                const opponentTeam = getOpponentTeam(pData.team, home_team, away_team);
                const projection = await calculateProjection(player_name, pData.team, opponentTeam, routesPerGame, yptData.yards_per_target);
                
                const edge = projection.expectedYards - parseFloat(line);
                
                const result = {
                    week: currentWeek, player_name, team: pData.team, opponent: opponentTeam, 
                    betting_line: parseFloat(line), odds: parseInt(odds), projection: projection.expectedYards, 
                    edge: edge.toFixed(1), recommendation: getRecommendation(edge), ...projection.debugStats
                };
                
                const actualYards = gamelogData.get(player_name);
                if (actualYards !== undefined) {
                    result.actual_yards = actualYards;
                    if (actualYards > result.betting_line) result.bet_outcome = 'WIN';
                    else if (actualYards < result.betting_line) result.bet_outcome = 'LOSS';
                    else result.bet_outcome = 'PUSH';
                }

                return result;

            } catch (error) {
                debugLog(`Failed to process ${player_name}: ${error.message}`);
                return null;
            }
        }

        async function calculateProjection(playerName, playerTeam, opponentTeam, routesPerGame, baseYPT) {
            const { data: oppCov, error: cErr } = await supabaseClient.from('defensive_coverages').select('*').eq('team_name', opponentTeam).eq('season', SEASON).single();
            if (cErr) throw new Error(`Coverage data for ${opponentTeam} not found.`);
            
            const { data: pStats, error: sErr } = await supabaseClient.from('player_cover_stats').select('coverage_type, tprr_player, separation_score').eq('player_name', playerName).eq('team', playerTeam).eq('season', SEASON);
            if (sErr || !pStats.length) throw new Error(`Detailed stats for ${playerName} not found.`);

            const statsMap = new Map(pStats.map(s => [s.coverage_type, s]));
            const covTypes = [{ n: 'Man Coverage', p: oppCov.man_pct }, { n: 'Cover 2', p: oppCov.cover_2_pct }, { n: 'Cover 3', p: oppCov.cover_3_pct }, { n: 'Cover 4', p: oppCov.cover_4_pct }, { n: 'Cover 6', p: oppCov.cover_6_pct }];

            let weightedTPRR = 0, weightedSep = 0, totalWeight = 0;
            covTypes.forEach(cov => {
                const stat = statsMap.get(cov.n);
                if (cov.p > 0 && stat) {
                    const weight = cov.p / 100;
                    weightedTPRR += (stat.tprr_player || 0) * weight;
                    weightedSep += (stat.separation_score || 0.2) * weight;
                    totalWeight += weight;
                }
            });

            if (totalWeight === 0) throw new Error('Could not calculate weighted stats.');
            weightedTPRR /= totalWeight; weightedSep /= totalWeight;
            
            const sepBonus = Math.max(0, (weightedSep - 0.15) * 10);
            const adjYPT = baseYPT + sepBonus;
            const gameScriptMult = 0.85 + (3 * 0.075);
            const expectedYards = (routesPerGame * weightedTPRR) * adjYPT * gameScriptMult;
            
            return {
                expectedYards: parseFloat(expectedYards.toFixed(1)),
                debugStats: { target_share: (statsMap.get('Overall')?.tprr_player * 100 || 0).toFixed(1), weighted_tprr: weightedTPRR.toFixed(4), base_ypt: baseYPT, separation_score: weightedSep.toFixed(3) }
            };
        }
        
        // --- UI and Display Functions ---
        
        function updateUI_AfterCSVLoad() {
            try {
                const weeks = [...new Set(csvData.map(r => parseInt(r.week)))].filter(Boolean).sort((a, b) => a - b);
                if (weeks.length === 0) throw new Error("No valid weeks found in 'week' column.");
                
                DOM.weekSelect.innerHTML = '<option value="">Choose a week...</option>';
                weeks.forEach(w => {
                    const count = csvData.filter(r => r.week == w && r.bet_type === 'Over').length;
                    DOM.weekSelect.innerHTML += `<option value="${w}">Week ${w} (${count} players)</option>`;
                });
                DOM.weekSelectorContainer.style.display = 'block';
                DOM.processWeekBtn.disabled = !DOM.weekSelect.value;
            } catch (error) {
                handleFatalError(error.message);
                csvData = null;
            }
        }

        function displayWeekResults() {
            const counts = weekResults.reduce((acc, r) => ({...acc, [r.recommendation]: (acc[r.recommendation] || 0) + 1 }), {});
            const totalActionable = (counts['GREAT OVER']||0) + (counts['MODERATE OVER']||0) + (counts['GREAT UNDER']||0) + (counts['MODERATE UNDER']||0);
            
            DOM.weekResultTitle.textContent = `Week ${currentWeek} Audit Results`;
            DOM.weekResultSummary.textContent = `${weekResults.length} players processed with ${totalActionable} actionable recommendations.`;
            DOM.recommendationsGrid.innerHTML = `
                <div class="recommendation-stat"><span class="count">${counts['GREAT OVER'] || 0}</span><span class="label">Great Over</span></div>
                <div class="recommendation-stat"><span class="count">${counts['MODERATE OVER'] || 0}</span><span class="label">Moderate Over</span></div>
                <div class="recommendation-stat"><span class="count">${counts['PASS'] || 0}</span><span class="label">Pass</span></div>
                <div class="recommendation-stat"><span class="count">${counts['MODERATE UNDER'] || 0}</span><span class="label">Moderate Under</span></div>
                <div class="recommendation-stat"><span class="count">${counts['GREAT UNDER'] || 0}</span><span class="label">Great Under</span></div>`;
            
            renderDetailedResultsTable();
            DOM.resultsContainer.style.display = 'block';
            showSuccess(`Week ${currentWeek} processing complete!`);
        }
        
        function renderDetailedResultsTable() {
            DOM.detailedResultsContainer.innerHTML = '';
            if (weekResults.length === 0) return;
            
            const table = document.createElement('table');
            table.className = 'results-table';
            const headers = ['Player', 'Team', 'Opp', 'Line', 'Proj.', 'Actual', 'Edge', 'Outcome', 'Rec.'];
            table.createTHead().insertRow().innerHTML = headers.map(h => `<th>${h}</th>`).join('');
            
            const tbody = table.createTBody();
            weekResults.forEach(r => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${r.player_name}</td><td>${r.team}</td><td>${r.opponent}</td>
                    <td>${r.betting_line.toFixed(1)}</td><td>${r.projection.toFixed(1)}</td>
                    <td>${r.actual_yards !== undefined ? r.actual_yards.toFixed(1) : 'N/A'}</td>
                    <td>${r.edge}</td>
                    <td class="${(r.bet_outcome || '').toLowerCase()}">${r.bet_outcome || 'N/A'}</td>
                    <td>${r.recommendation}</td>
                `;
            });
            DOM.detailedResultsContainer.appendChild(table);
        }

        // --- Utility Functions ---

        function getRecommendation(edge) {
            if (edge >= 15) return 'GREAT OVER'; if (edge >= 6) return 'MODERATE OVER';
            if (edge <= -15) return 'GREAT UNDER'; if (edge <= -6) return 'MODERATE UNDER';
            return 'PASS';
        }
        
        function getOpponentTeam(playerTeam, homeTeam, awayTeam) {
            return playerTeam.trim().toLowerCase() === homeTeam.trim().toLowerCase() ? awayTeam.trim() : homeTeam.trim();
        }

        function downloadResults() {
            if (!weekResults.length) { showError('No results to download.'); return; }
            debugLog('Initiating CSV download...');
            
            let headers = ['Week','Player','Team','Opponent','Line','Odds','Projection','ActualYards','Edge','BetOutcome','Rec','TargetShare','WeightedTPRR','BaseYPT','SepScore'];
            let csvContent = headers.join(',') + '\n';
            weekResults.forEach(r => {
                let row = [
                    r.week, `"${r.player_name}"`, `"${r.team}"`, `"${r.opponent}"`, r.betting_line, r.odds, 
                    r.projection, r.actual_yards ?? '', r.edge, r.bet_outcome ?? '', `"${r.recommendation}"`, 
                    r.target_share, r.weighted_tprr, r.base_ypt, r.separation_score
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `nfl_receiving_yards_week_${currentWeek}_audit.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        function resetUIForNewWeek() {
            weekResults = [];
            hideAllMessages();
            DOM.detailedResultsContainer.innerHTML = '';
        }

        function showLoading(isLoading, text = '') {
            DOM.loadingDiv.textContent = text;
            DOM.loadingDiv.style.display = isLoading ? 'block' : 'none';
            DOM.processWeekBtn.disabled = isLoading;
        }

        function updateProgress(current, total, text) {
            const container = DOM.weekProgressContainer;
            container.style.display = 'block';
            if (!container.innerHTML) {
                container.innerHTML = `<div class="week-progress"><div class="progress-bar"><div class="progress-fill"></div></div><div class="progress-text"></div></div>`;
            }
            container.querySelector('.progress-fill').style.width = total > 0 ? `${(current / total) * 100}%` : '0%';
            container.querySelector('.progress-text').textContent = `Processing ${current} / ${total}: ${text}`;
        }
        
        function updateFileStatus(element, text, isSuccess = true) {
            element.textContent = text;
            element.className = 'file-status ' + (isSuccess ? 'loaded' : 'pending');
        }
        
        function hideAllMessages() { [DOM.errorDiv, DOM.successDiv, DOM.loadingDiv, DOM.resultsContainer, DOM.weekProgressContainer].forEach(el => el.style.display = 'none'); }
        function showError(message) { DOM.errorDiv.textContent = message; DOM.errorDiv.style.display = 'block'; }
        function showSuccess(message) { DOM.successDiv.textContent = message; DOM.successDiv.style.display = 'block'; }
        function enableDebugMode() { DOM.debugConsole.style.display = 'block'; debugLog('Debug mode enabled.'); }
        function debugLog(message) { if (DOM.debugOutput) { DOM.debugOutput.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}<br>`; DOM.debugOutput.scrollTop = DOM.debugOutput.scrollHeight; } console.log(message); }
        function handleFatalError(message) { enableDebugMode(); showError(message); debugLog(`FATAL: ${message}`); }
    </script>
</body>
</html>
